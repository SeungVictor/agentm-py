name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: self-hosted

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black flake8

      - name: Run flake8
        run: flake8 src/ tests/ | tee flake8-output.log

      - name: Run black
        run: black --check src/ tests/ | tee black-output.log

      - name: Run tests
        run: pytest | tee pytest-output.log

      - name: Push logs to Loki
        env:
          LOKI_URL: ${{ secrets.LOKI_URL }}
          LOKI_USER: ${{ secrets.LOKI_USER }}
          LOKI_PASS: ${{ secrets.LOKI_PASS }}
        run: |
          curl -u "$LOKI_USER:$LOKI_PASS" -X POST "$LOKI_URL/loki/api/v1/push" \
          -H "Content-Type: application/json" \
          -d '{
            "streams": [
              {
                "stream": { "job": "ci-cd-pipeline", "level": "INFO" },
                "values": [
                  ["'"$(date +%s%N)"'", "INFO: CI log entry 1"]
                ]
              },
              {
                "stream": { "job": "ci-cd-pipeline", "level": "ERROR" },
                "values": [
                  ["'"$(date +%s%N)"'", "ERROR: CI log entry 2"]
                ]
              }
            ]
          }'

